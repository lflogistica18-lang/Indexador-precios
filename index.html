<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indexador | Dashboard IPC Argentina</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        teal: {
                            50: '#E0F2F1', 100: '#B2DFDB', 200: '#80CBC4',
                            300: '#4DB6AC', 400: '#26A69A', 500: '#009688',
                            600: '#00897B', 700: '#00796B', 800: '#00695C', 900: '#004D40',
                            a100: '#A7FFEB', a200: '#64FFDA', a400: '#1DE9B6', a700: '#00BFA5'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            background-color: #f0f7f6;
            color: #004D40;
            font-family: 'Outfit', sans-serif;
            min-height: 100vh;
            display: flex;
        }

        /* ── Scrollbar ── */
        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        ::-webkit-scrollbar-track {
            background: #E0F2F1;
        }

        ::-webkit-scrollbar-thumb {
            background: #80CBC4;
            border-radius: 4px;
        }

        /* ── Sidebar ── */
        #sidebar {
            width: 260px;
            min-width: 260px;
            min-height: 100vh;
            background: linear-gradient(180deg, #004D40 0%, #00695C 40%, #009688 100%);
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 1.5rem 1.25rem;
            gap: 0;
        }

        /* Fix dropdown options background inside dark sidebar */
        #sidebar select option {
            background-color: #00695C;
            color: #E0F2F1;
        }

        /* ── Cards ── */
        .card {
            background: #ffffff;
            border-radius: 14px;
            border: 1px solid #B2DFDB;
            box-shadow: 0 1px 8px rgba(0, 77, 64, 0.07);
        }

        .card-teal {
            background: linear-gradient(135deg, #009688, #00695C);
            border-radius: 14px;
        }

        .card-light {
            background: #E0F2F1;
            border-radius: 14px;
            border: 1px solid #B2DFDB;
        }

        /* ── KPI hover ── */
        .kpi-card {
            transition: transform .2s, box-shadow .2s;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 150, 136, .15);
        }

        /* ── Sidebar inputs ── */
        .sidebar-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.25);
            color: #E0F2F1;
            border-radius: 8px;
            padding: .45rem .7rem;
            font-size: .85rem;
            font-family: 'Outfit', sans-serif;
            outline: none;
        }

        .sidebar-input:focus {
            border-color: #64FFDA;
            background: rgba(255, 255, 255, 0.2);
        }

        .sidebar-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        /* ── Branch row ── */
        .branch-row:hover {
            background: #E0F2F1;
        }

        /* ── Badge ── */
        .badge-ok {
            background: #ccfbf1;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .badge-nom {
            background: #fefce8;
            color: #854d0e;
            border: 1px solid #fde68a;
        }

        .badge-err {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        /* ── Speculation tag ── */
        .tag-spec {
            background: #fef9c3;
            color: #713f12;
        }

        .tag-ofic {
            background: #d1fae5;
            color: #065f46;
        }

        /* Table header */
        .th {
            font-size: .7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .06em;
            color: #26A69A;
            padding: .6rem .75rem;
        }

        .td {
            padding: .65rem .75rem;
            font-size: .82rem;
            color: #004D40;
            border-top: 1px solid #E0F2F1;
        }
    </style>
</head>

<body>

    <!-- ═══════════════════════════════════════════
     SIDEBAR
═══════════════════════════════════════════ -->
    <aside id="sidebar">

        <!-- Logo -->
        <div class="mb-7">
            <div class="flex items-center gap-2.5 mb-0.5">
                <div class="h-9 w-9 rounded-xl bg-teal-a200/20 flex items-center justify-center flex-shrink-0">
                    <i class="fa-solid fa-arrow-trend-up text-teal-a200 text-lg"></i>
                </div>
                <span class="text-2xl font-extrabold text-white tracking-tight">Indexador</span>
            </div>
            <p class="text-white/40 text-xs pl-11">Sistema IPC · Argentina</p>
        </div>

        <!-- API Status -->
        <div class="mb-5 p-3 rounded-xl bg-white/10 border border-white/10">
            <p class="text-xs text-white/40 uppercase font-bold mb-1.5 tracking-wider">Fuente API</p>
            <div class="flex items-center gap-2">
                <span id="status-icon"><i class="fa-solid fa-circle-notch fa-spin text-yellow-300 text-sm"></i></span>
                <span id="status-text" class="text-sm text-white font-medium">Conectando...</span>
            </div>
            <p class="text-white/30 text-xs mt-1">INDEC · datos.gob.ar</p>
        </div>

        <!-- Sucursal -->
        <div class="mb-5">
            <p class="text-xs text-white/40 uppercase font-bold mb-2 tracking-wider">Sucursal</p>
            <form id="branch-form" class="space-y-2">
                <input type="text" id="branch-name" placeholder="Nombre de sucursal" class="sidebar-input" required>
                <input type="number" id="branch-amount" placeholder="Importe base ($)" class="sidebar-input" step="0.01"
                    required>
                <button type="submit"
                    class="w-full bg-teal-a400/80 hover:bg-teal-a400 text-teal-900 font-bold py-2 px-4 rounded-lg text-sm transition-all">
                    <i class="fa-solid fa-plus mr-1.5"></i>Agregar Sucursal
                </button>
            </form>
        </div>

        <!-- Período -->
        <div class="mb-5">
            <p class="text-xs text-white/40 uppercase font-bold mb-2 tracking-wider">Período de Cálculo</p>
            <div class="space-y-2">
                <div>
                    <label class="text-xs text-white/50 block mb-1">Desde</label>
                    <select id="start-month" class="sidebar-input"></select>
                </div>
                <div>
                    <label class="text-xs text-white/50 block mb-1">Hasta</label>
                    <select id="end-month" class="sidebar-input"></select>
                </div>
            </div>
        </div>

        <!-- Semáforo de Rentabilidad -->
        <div class="mt-auto">
            <p class="text-xs text-white/40 uppercase font-bold mb-2 tracking-wider">Rentabilidad</p>
            <div>
                <label class="text-xs text-white/50 block mb-1">% Incremento de Costos</label>
                <input type="number" id="cost-input" value="0" step="0.1" placeholder="0.00" class="sidebar-input">
            </div>
            <div id="profit-alert"
                class="hidden mt-2 bg-red-500/20 border border-red-400/30 rounded-lg p-2 text-xs text-red-200">
                <i class="fa-solid fa-triangle-exclamation mr-1"></i> ¡Costos superan la indexación!
            </div>
            <div id="profit-warn"
                class="hidden mt-2 bg-yellow-400/20 border border-yellow-300/30 rounded-lg p-2 text-xs text-yellow-200">
                <i class="fa-solid fa-circle-exclamation mr-1"></i> Margen ajustado, revisar.
            </div>
            <div id="profit-ok"
                class="hidden mt-2 bg-teal-a400/20 border border-teal-a400/30 rounded-lg p-2 text-xs text-teal-a200">
                <i class="fa-solid fa-circle-check mr-1"></i> Margen saludable ✓
            </div>

            <!-- Buttons -->
            <div class="mt-5 space-y-2">
                <button onclick="app.handlers.exportPDF()"
                    class="w-full bg-white/15 hover:bg-white/25 text-white font-semibold py-2 px-4 rounded-lg text-sm transition-all">
                    <i class="fa-solid fa-file-pdf mr-2"></i>Exportar PDF
                </button>
                <button onclick="app.handlers.resetData()"
                    class="w-full bg-white/08 hover:bg-white/15 text-white/60 py-1.5 px-4 rounded-lg text-xs transition-all">
                    <i class="fa-solid fa-rotate mr-1.5"></i>Reset datos
                </button>
            </div>
        </div>
    </aside>

    <!-- ═══════════════════════════════════════════
     MAIN
═══════════════════════════════════════════ -->
    <main class="flex-1 p-5 md:p-7 space-y-5 overflow-auto">

        <!-- Header -->
        <header class="flex flex-wrap items-start justify-between gap-3">
            <div>
                <h1 class="text-xl font-bold text-teal-800">Dashboard de Indexación IPC</h1>
                <p id="validity-legend" class="text-xs text-teal-600 mt-0.5">
                    <i class="fa-solid fa-calendar-check mr-1"></i>Calculando vigencia...
                </p>
            </div>
            <!-- Trimestre badge -->
            <div id="trimester-badge"
                class="hidden px-4 py-2 card-light text-sm font-semibold text-teal-700 flex items-center gap-2">
                <i class="fa-solid fa-calendar-days text-teal-500"></i>
                <span id="trimester-label">—</span>
            </div>
        </header>

        <!-- ── ROW 1: KPIs ── -->
        <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">

            <!-- Anual Acumulada -->
            <div class="card kpi-card p-4">
                <div class="flex items-start justify-between mb-2">
                    <p class="text-xs font-bold text-teal-400 uppercase tracking-wider">Acum. Anual</p>
                    <span class="h-7 w-7 rounded-lg bg-teal-50 flex items-center justify-center">
                        <i class="fa-solid fa-calendar-year text-teal-500 text-xs"></i>
                    </span>
                </div>
                <p class="text-3xl font-extrabold text-teal-800" id="kpi-annual">—</p>
                <p class="text-xs text-teal-400 mt-0.5">Últimos 12 meses</p>
            </div>

            <!-- Ajuste del Período Seleccionado -->
            <div class="card-teal kpi-card p-4 text-white">
                <div class="flex items-start justify-between mb-2">
                    <p class="text-xs font-bold text-teal-100/70 uppercase tracking-wider">Ajuste Período</p>
                    <span class="h-7 w-7 rounded-lg bg-white/15 flex items-center justify-center">
                        <i class="fa-solid fa-bolt text-teal-a200 text-xs"></i>
                    </span>
                </div>
                <p class="text-3xl font-extrabold text-white" id="kpi-custom-period">—</p>
                <p class="text-xs text-teal-100/60 mt-0.5" id="period-type-label">Período seleccionado</p>
            </div>

            <!-- Trimestre Dic-Ene-Feb -->
            <div class="card kpi-card p-4">
                <div class="flex items-start justify-between mb-2">
                    <p class="text-xs font-bold text-teal-400 uppercase tracking-wider">Factor Dic-Ene-Feb</p>
                    <span id="feb-type-badge" class="text-xs px-2 py-0.5 rounded-full font-semibold tag-nom">·</span>
                </div>
                <p class="text-3xl font-extrabold text-teal-800" id="kpi-trimester">—</p>
                <p class="text-xs text-teal-400 mt-0.5">Inflación compuesta</p>
            </div>

            <!-- Status INDEC -->
            <div class="card kpi-card p-4">
                <div class="flex items-start justify-between mb-2">
                    <p class="text-xs font-bold text-teal-400 uppercase tracking-wider">Fuente INDEC</p>
                    <span id="api-status-dot" class="h-2.5 w-2.5 rounded-full bg-yellow-400 mt-1"></span>
                </div>
                <div class="flex items-center gap-2 mt-1">
                    <span id="api-status-icon2" class="text-xl"><i
                            class="fa-solid fa-circle-notch fa-spin text-yellow-400"></i></span>
                    <div>
                        <p class="text-sm font-bold text-teal-800" id="api-status-text2">Conectando...</p>
                        <p class="text-xs text-teal-400">datos.gob.ar</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ── ROW 2: Resumen Sucursales + Historial (misma fila) ── -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-5">

            <!-- Resumen de Sucursales (2/3) -->
            <div class="xl:col-span-2 card p-5">
                <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
                    <h3 class="text-sm font-bold text-teal-700 flex items-center gap-2">
                        <i class="fa-solid fa-building text-teal-500"></i>Resumen de Sucursales · Precios para Clientes
                    </h3>
                    <div id="adjustment-summary-badge"
                        class="px-3 py-1 rounded-full bg-teal-100 text-teal-700 text-xs font-bold hidden">
                        Ajuste: <span id="adj-badge-value">—</span>
                    </div>
                </div>

                <div class="overflow-x-auto rounded-xl border border-teal-100">
                    <table class="w-full text-left">
                        <thead class="bg-teal-50">
                            <tr>
                                <th class="th">Sucursal</th>
                                <th class="th text-right">Precio Base</th>
                                <th class="th text-right text-teal-600">Ajuste %</th>
                                <th class="th text-right font-extrabold text-teal-700">★ Nuevo Precio</th>
                                <th class="th text-right">Incremento $</th>
                                <th class="th text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="branches-list-body" class="divide-y divide-teal-50"></tbody>
                        <tfoot>
                            <tr class="border-t-2 border-teal-200 bg-teal-50/50 font-bold">
                                <td class="td text-teal-600 uppercase text-xs">Total Consolidado</td>
                                <td class="td text-right text-teal-500" id="total-current">—</td>
                                <td class="td text-right" id="total-adj-pct">—</td>
                                <td class="td text-right text-teal-700 text-base" id="total-new">—</td>
                                <td class="td text-right text-teal-500" id="total-diff">—</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div id="empty-state" class="hidden text-center py-8 text-teal-300">
                    <i class="fa-solid fa-shop text-3xl mb-2 block"></i>
                    <p class="text-sm">Agregá sucursales desde el panel lateral</p>
                </div>

                <!-- Leyenda legal -->
                <div
                    class="mt-3 p-2.5 rounded-xl bg-teal-50 border border-teal-200 text-xs text-teal-600 leading-relaxed">
                    <i class="fa-solid fa-circle-info mr-1 text-teal-400"></i>
                    <span id="legal-legend">Calculando leyenda de vigencia...</span>
                </div>
            </div>

            <!-- Historial Semestral (1/3) -->
            <div class="xl:col-span-1 card p-5">
                <h3 class="text-sm font-bold text-teal-700 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-table-list text-teal-500"></i>Historial Semestral
                </h3>
                <div class="rounded-xl overflow-hidden border border-teal-100">
                    <table class="w-full text-left">
                        <thead class="bg-teal-50">
                            <tr>
                                <th class="th">Mes</th>
                                <th class="th text-right">IPC%</th>
                                <th class="th text-center">Tipo</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ── ROW 3: Gráfico achatado con acumulado del período ── -->
        <div class="card p-5">
            <!-- Banner acumulado del período del gráfico -->
            <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
                <div class="flex items-center gap-4">
                    <h3 class="text-sm font-bold text-teal-700 flex items-center gap-2">
                        <i class="fa-solid fa-chart-line text-teal-500"></i>Tendencia Inflación Mensual
                    </h3>
                    <!-- Acumulado dinámico según el filtro del gráfico -->
                    <div class="flex items-center gap-2 bg-teal-50 border border-teal-200 rounded-xl px-3 py-1.5">
                        <span class="text-xs text-teal-500 font-semibold uppercase tracking-wide">Acumulado del
                            período:</span>
                        <span class="text-lg font-extrabold text-teal-700" id="chart-accumulated">—</span>
                        <span class="text-xs text-teal-400" id="chart-range-label">(12 meses)</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <label class="text-xs text-teal-500">Mostrar:</label>
                    <select id="chart-range"
                        class="text-xs border border-teal-200 rounded-lg px-2 py-1 text-teal-700 outline-none bg-teal-50 focus:border-teal-500">
                        <option value="6">6 meses</option>
                        <option value="12" selected>12 meses</option>
                        <option value="24">24 meses</option>
                        <option value="all">Todo</option>
                    </select>
                    <label class="flex items-center gap-1.5 text-xs text-teal-500 cursor-pointer select-none">
                        <input type="checkbox" id="chart-interanual" class="accent-teal-500 rounded">
                        Interanual
                    </label>
                </div>
            </div>
            <!-- Canvas achatado: height fijo en CSS para que quede compacto -->
            <div style="height:150px; position:relative;">
                <canvas id="inflation-chart" style="height:150px !important;"></canvas>
            </div>
        </div>

    </main>

    <!-- ═══════════════════════════════
     JAVASCRIPT
═══════════════════════════════ -->
    <script>
        // ─── UTILS ──────────────────────────────────────────────
        const UTILS = {
            fmtCurrency: v => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 }).format(v),
            fmtPct: v => (v != null ? v.toFixed(2) + '%' : '—'),
            genId: () => '_' + Math.random().toString(36).substr(2, 9),
        };

        // ─── MONTH NAMES ───────────────────────────────────────
        const MONTH_NAMES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        // ─── STATE ──────────────────────────────────────────────
        const State = {
            data: {
                branches: [],
                inflationData: [],
                settings: { userCostIncrease: 0, startMonth: '', endMonth: '' }
            },
            load() {
                const s = localStorage.getItem('indexadorV3');
                if (s) { const p = JSON.parse(s); this.data.branches = p.branches || []; this.data.settings = p.settings || {}; }
            },
            save() {
                localStorage.setItem('indexadorV3', JSON.stringify({ branches: this.data.branches, settings: this.data.settings }));
            }
        };

        // ─── CORE ENGINE ────────────────────────────────────────
        /**
         * Protocolo de Verificación Dic-Ene-Feb con cláusula especulativa.
         *
         * CASO A – Feb oficial disponible  → usa valor real de API
         * CASO B – Feb no disponible        → IPC_Feb = (IPC_Dic + IPC_Ene) / 2
         *
         * Fórmula compuesta: (1+i_dic)×(1+i_ene)×(1+i_feb) − 1
         */
        function calcTrimester(inflData) {
            if (!inflData || !inflData.length) return null;

            const now = new Date();
            const year = now.getFullYear();
            const prev = year - 1;

            // ── Helper: busca por año + mes exacto ──
            const findMonth = (yr, mo) =>
                inflData.find(d =>
                    d.dateObj.getFullYear() === yr &&
                    d.dateObj.getMonth() === mo
                ) || null;

            const dicEntry = findMonth(prev, 11); // Diciembre año anterior
            const eneEntry = findMonth(year, 0); // Enero año actual
            const febEntry = findMonth(year, 1); // Febrero año actual

            // Dic y Ene son SIEMPRE requeridos (datos oficiales)
            if (!dicEntry || dicEntry.value == null) {
                console.warn('[calcTrimester] Falta Dic oficial →', dicEntry);
                return null;
            }
            if (!eneEntry || eneEntry.value == null) {
                console.warn('[calcTrimester] Falta Ene oficial →', eneEntry);
                return null;
            }

            // ── CASO A / B : Feb ──
            let febValue;
            let febIsSpeculative;

            if (febEntry && febEntry.value != null && !febEntry.isEstimated) {
                // CASO A: dato oficial confirmado
                febValue = febEntry.value;
                febIsSpeculative = false;
            } else {
                // CASO B: dato no disponible → especulativo = promedio Dic+Ene
                febValue = parseFloat(((dicEntry.value + eneEntry.value) / 2).toFixed(2));
                febIsSpeculative = true;
                console.info(`[calcTrimester] Feb especulativo = (${dicEntry.value} + ${eneEntry.value}) / 2 = ${febValue}`);
            }

            // ── Factor compuesto (capitalización) ──
            const iDic = dicEntry.value / 100;
            const iEne = eneEntry.value / 100;
            const iFeb = febValue / 100;
            const factor = (1 + iDic) * (1 + iEne) * (1 + iFeb) - 1;

            console.info(
                `[calcTrimester] Dic=${dicEntry.value}% | Ene=${eneEntry.value}% | Feb=${febValue}% (${febIsSpeculative ? 'ESPECULATIVO' : 'OFICIAL'})`,
                `→ Factor=${(factor * 100).toFixed(4)}%`
            );

            return {
                factor,
                pct: parseFloat((factor * 100).toFixed(4)),
                dic: dicEntry.value,
                ene: eneEntry.value,
                feb: febValue,
                febIsSpeculative,
                coverageLabel: `Precio garantizado para Marzo–Mayo ${year}`,
                nextUpdate: `18/05/${year}`,
                legalNote: `Ajuste basado en periodo Dic-${prev} / Ene-${year} / Feb-${year}. Valor vigente para el trimestre Marzo-Mayo ${year}. Proxima actualizacion: 18/05/${year}.`
            };





        }

        /**
         * Cálculo de índice compuesto para un rango arbitrario de meses.
         */
        function calcPeriodIndex(inflData, startISO, endISO) {
            if (!inflData.length || !startISO || !endISO) return 0;
            const si = inflData.findIndex(d => d.iso === startISO);
            const ei = inflData.findIndex(d => d.iso === endISO);
            if (si === -1 || ei === -1 || si > ei) return 0;
            const vals = inflData.slice(si, ei + 1).map(d => d.value);
            return vals.reduce((acc, v) => acc * (1 + v / 100), 1) - 1;
        }

        // ─── LOGIC ──────────────────────────────────────────────
        let chartInst = null;

        const Logic = {
            async fetchInflationData() {
                const setStatus = (type, txt) => {
                    const icons = {
                        loading: '<i class="fa-solid fa-circle-notch fa-spin text-yellow-300 text-sm"></i>',
                        ok: '<i class="fa-solid fa-circle-check text-teal-a400 text-sm"></i>',
                        error: '<i class="fa-solid fa-circle-xmark text-red-400 text-sm"></i>'
                    };
                    const icons2 = {
                        loading: '<i class="fa-solid fa-circle-notch fa-spin text-yellow-400 text-2xl"></i>',
                        ok: '<i class="fa-solid fa-satellite-dish text-teal-500 text-2xl"></i>',
                        error: '<i class="fa-solid fa-wifi text-red-400 text-2xl"></i>'
                    };
                    const dots = { loading: 'bg-yellow-400', ok: 'bg-teal-400', error: 'bg-red-400' };

                    document.getElementById('status-icon').innerHTML = icons[type];
                    document.getElementById('status-text').textContent = txt;
                    document.getElementById('api-status-icon2').innerHTML = icons2[type];
                    document.getElementById('api-status-text2').textContent = txt;
                    document.getElementById('api-status-dot').className = `h-2.5 w-2.5 rounded-full mt-1 ${dots[type]}`;
                };

                setStatus('loading', 'Conectando...');

                try {
                    const res = await fetch(
                        'https://apis.datos.gob.ar/series/api/series/?ids=145.3_INGNACUAL_DICI_M_38&limit=5000&format=json'
                    );
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    const json = await res.json();
                    if (!json.data?.length) throw new Error('Sin datos');

                    // ── Detectar si los valores vienen en formato decimal (0.06) o porcentaje (6) ──
                    const sample = json.data.slice(-12).map(x => x[1]).filter(v => v !== null);
                    const sorted = [...sample].sort((a, b) => a - b);
                    const median = sorted[Math.floor(sorted.length / 2)];
                    const isDecimal = median !== null && median < 2;

                    // ── Parsear TODOS los registros desde 2022, incluir nulls marcados como estimados ──
                    const parsed = json.data
                        .map(item => {
                            const d = new Date(item[0] + 'T12:00:00');
                            const raw = item[1];
                            const hasValue = raw !== null && raw !== undefined;
                            const v = hasValue ? (isDecimal ? raw * 100 : raw) : null;
                            return {
                                dateObj: d,
                                label: d.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' }),
                                value: hasValue ? parseFloat(v.toFixed(2)) : null,
                                isEstimated: !hasValue,   // null desde API = pendiente oficial
                                iso: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`
                            };
                        })
                        .filter(d => d.dateObj.getFullYear() >= 2022)
                        .sort((a, b) => a.dateObj - b.dateObj);

                    // ── Inyectar Feb especulativo si la API lo deja como null ──
                    const now = new Date();
                    const year = now.getFullYear();
                    const febISO = `${year}-02`;
                    const dicISO = `${year - 1}-12`;
                    const eneISO = `${year}-01`;

                    const febInData = parsed.find(d => d.iso === febISO);
                    if (!febInData || febInData.value === null) {
                        // No vino de la API o vino null → crear entrada especulativa
                        const dicV = parsed.find(d => d.iso === dicISO)?.value;
                        const eneV = parsed.find(d => d.iso === eneISO)?.value;
                        if (dicV != null && eneV != null) {
                            const specVal = parseFloat(((dicV + eneV) / 2).toFixed(2));
                            if (!febInData) {
                                // Agregar el nodo Feb al array
                                const febDate = new Date(`${febISO}-01T12:00:00`);
                                parsed.push({
                                    dateObj: febDate,
                                    label: febDate.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' }),
                                    value: specVal,
                                    isEstimated: true,
                                    iso: febISO
                                });
                                parsed.sort((a, b) => a.dateObj - b.dateObj);
                            } else {
                                // Actualizar el nodo existente con valor especulativo
                                febInData.value = specVal;
                                febInData.isEstimated = true;
                            }
                            console.info(`[fetchInflation] Feb especulativo inyectado = ${specVal}%`);
                        }
                    }

                    State.data.inflationData = parsed;
                    setStatus('ok', 'Oficial INDEC');

                    if (!State.data.settings.endMonth && parsed.length > 0) {
                        // Por defecto el período va desde Dic del año anterior hasta el último dato
                        const L = parsed.length;
                        const end = parsed[L - 1].iso;
                        // Buscar el Dic del año anterior como inicio por defecto
                        const defStart = parsed.find(d => d.iso === dicISO)?.iso ||
                            parsed[Math.max(0, L - 3)].iso;
                        State.data.settings.endMonth = end;
                        State.data.settings.startMonth = defStart;
                    }

                } catch (e) {
                    console.error('[API Error]', e);
                    setStatus('error', 'Sin conexión — usando datos demo ✕');
                    await this.mockData();
                }
            },

            /**
             * Datos de demostración coherentes con el ciclo Dic-Ene-Feb.
             * Siempre genera un Dic del año anterior con valor real para que
             * calcTrimester pueda operar sin fallos.
             */
            async mockData() {
                const today = new Date();
                const year = today.getFullYear();
                const prev = year - 1;
                const data = [];

                // Base histórica: 27 meses hacia atrás
                for (let i = 27; i >= 0; i--) {
                    const d = new Date(year, today.getMonth() - i, 1);
                    // Valores demo realistas (Argentina 2024-2026)
                    const v = parseFloat((Math.max(2.5, Math.sin(i * 0.6) * 4 + 8 + Math.random() * 3)).toFixed(1));
                    data.push({
                        dateObj: d,
                        value: v,
                        isEstimated: false,
                        label: d.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' }),
                        iso: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`
                    });
                }

                // ── Asegurar que Dic(año anterior), Ene y Feb existen con valores coherentes ──
                const ensureMonth = (yr, mo, val) => {
                    const iso = `${yr}-${String(mo + 1).padStart(2, '0')}`;
                    if (!data.find(d => d.iso === iso)) {
                        const date = new Date(yr, mo, 1);
                        data.push({
                            dateObj: date,
                            value: val,
                            isEstimated: mo === 1, // Feb siempre estimado en demo
                            label: date.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' }),
                            iso
                        });
                    }
                };

                // Valores demo fijos para el trimestre de referencia
                const dicVal = 2.4;   // Dic 2025: dato publicado INDEC
                const eneVal = 2.3;   // Ene 2026: dato publicado INDEC
                ensureMonth(prev, 11, dicVal);                          // Dic año anterior
                ensureMonth(year, 0, eneVal);                          // Enero
                ensureMonth(year, 1, parseFloat(((dicVal + eneVal) / 2).toFixed(2))); // Feb especulativo

                data.sort((a, b) => a.dateObj - b.dateObj);
                State.data.inflationData = data;

                const L = data.length;
                const dicISO = `${prev}-12`;
                State.data.settings.endMonth = data[L - 1].iso;
                State.data.settings.startMonth = data.find(d => d.iso === dicISO)?.iso || data[Math.max(0, L - 3)].iso;

                console.info('[mockData] Dataset demo cargado. Meses clave:',
                    { dic: `${prev}-12 = ${dicVal}%`, ene: `${year}-01 = ${eneVal}%`, feb: `${year}-02 (especulativo)` });
            },

            getKPIs() {
                const data = State.data.inflationData;
                if (!data.length) return { annual: null };
                const last12 = data.slice(-12);
                let acc = 1;
                last12.forEach(d => acc *= (1 + d.value / 100));
                return { annual: (acc - 1) * 100 };
            },

            addBranch(name, amount) {
                State.data.branches.push({ id: UTILS.genId(), name, amount: parseFloat(amount) });
                State.save(); App.render();
            },

            removeBranch(id) {
                State.data.branches = State.data.branches.filter(b => b.id !== id);
                State.save(); App.render();
            }
        };

        // ─── APP ────────────────────────────────────────────────
        const App = {
            async init() {
                State.load();

                document.getElementById('branch-form').addEventListener('submit', e => {
                    e.preventDefault();
                    Logic.addBranch(
                        document.getElementById('branch-name').value.trim(),
                        document.getElementById('branch-amount').value
                    );
                    e.target.reset();
                    document.getElementById('branch-name').focus();
                });

                document.getElementById('cost-input').addEventListener('input', e => {
                    State.data.settings.userCostIncrease = parseFloat(e.target.value) || 0;
                    State.save(); App.updateProfit();
                });

                ['start-month', 'end-month'].forEach(id => {
                    document.getElementById(id).addEventListener('change', e => {
                        State.data.settings[id === 'start-month' ? 'startMonth' : 'endMonth'] = e.target.value;
                        State.save(); App.render();
                    });
                });

                document.getElementById('chart-range').addEventListener('change', App.renderChart);
                document.getElementById('chart-interanual').addEventListener('change', App.renderChart);

                await Logic.fetchInflationData();
                App.populateSelects();
                App.render();
            },

            populateSelects() {
                ['start-month', 'end-month'].forEach(id => {
                    const sel = document.getElementById(id);
                    sel.innerHTML = '';
                    State.data.inflationData.forEach(item => sel.add(new Option(item.label, item.iso)));
                });
                document.getElementById('start-month').value = State.data.settings.startMonth;
                document.getElementById('end-month').value = State.data.settings.endMonth;
            },

            render() {
                const infData = State.data.inflationData;
                const kpis = Logic.getKPIs();
                const trimResult = calcTrimester(infData);
                const periodPct = calcPeriodIndex(infData, State.data.settings.startMonth, State.data.settings.endMonth) * 100;

                // ── KPI: Anual ──
                document.getElementById('kpi-annual').textContent = UTILS.fmtPct(kpis.annual);

                // ── KPI: Período seleccionado ──
                document.getElementById('kpi-custom-period').textContent = UTILS.fmtPct(periodPct);

                // ── KPI: Trimestre Dic-Ene-Feb ──
                if (trimResult) {
                    document.getElementById('kpi-trimester').textContent = UTILS.fmtPct(trimResult.pct);
                    const febBadge = document.getElementById('feb-type-badge');
                    febBadge.className = 'text-xs px-2 py-0.5 rounded-full font-semibold tag-ofic';
                    febBadge.textContent = 'Dic-Ene-Feb';

                    // Trimester badge header
                    const tb = document.getElementById('trimester-badge');
                    tb.classList.remove('hidden');
                    document.getElementById('trimester-label').textContent =
                        `Dic/${(new Date().getFullYear() - 1)} · Ene-Feb/${new Date().getFullYear()} → Mar-May`;

                    // Validity
                    document.getElementById('validity-legend').innerHTML =
                        `<i class="fa-solid fa-calendar-check mr-1 text-teal-500"></i>
                 Vigencia: Marzo–Mayo ${new Date().getFullYear()} · Próx. actualización: <strong>${trimResult.nextUpdate}</strong>`;

                    document.getElementById('legal-legend').textContent = trimResult.legalNote;
                }

                // ── Adjustment badge ──
                const adjPct = trimResult ? trimResult.pct : periodPct;
                document.getElementById('adj-badge-value').textContent = UTILS.fmtPct(adjPct);
                document.getElementById('adjustment-summary-badge').classList.remove('hidden');

                // ── Branches Table ──
                const tbody = document.getElementById('branches-list-body');
                const empty = document.getElementById('empty-state');
                tbody.innerHTML = '';
                let tCurrent = 0, tNew = 0, tDiff = 0;

                if (!State.data.branches.length) {
                    empty.classList.remove('hidden');
                } else {
                    empty.classList.add('hidden');
                    State.data.branches.forEach(b => {
                        const newAmt = b.amount * (1 + adjPct / 100);
                        const diff = newAmt - b.amount;
                        tCurrent += b.amount; tNew += newAmt; tDiff += diff;

                        const tr = document.createElement('tr');
                        tr.className = 'branch-row transition-colors';
                        tr.innerHTML = `
                    <td class="td font-semibold">${b.name}</td>
                    <td class="td text-right text-teal-400">${UTILS.fmtCurrency(b.amount)}</td>
                    <td class="td text-right font-bold text-teal-600 font-mono">+${UTILS.fmtPct(adjPct)}</td>
                    <td class="td text-right font-extrabold text-teal-800 text-base">${UTILS.fmtCurrency(newAmt)}</td>
                    <td class="td text-right text-teal-500 font-mono text-xs">+${UTILS.fmtCurrency(diff)}</td>
                    <td class="td text-center">
                        <button onclick="Logic.removeBranch('${b.id}')" class="text-teal-200 hover:text-red-400 transition-colors">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </td>`;
                        tbody.appendChild(tr);
                    });
                }

                document.getElementById('total-current').textContent = UTILS.fmtCurrency(tCurrent);
                document.getElementById('total-new').textContent = UTILS.fmtCurrency(tNew);
                document.getElementById('total-diff').textContent = '+' + UTILS.fmtCurrency(tDiff);
                document.getElementById('total-adj-pct').textContent = UTILS.fmtPct(adjPct);

                // ── History Table ──
                const hbody = document.getElementById('history-table-body');
                hbody.innerHTML = '';
                // Solo mostrar meses con valor real (no nulls pendientes)
                const last6 = [...infData].filter(d => d.value !== null).slice(-6).reverse();
                last6.forEach(item => {
                    const high = item.value > 10;
                    hbody.innerHTML += `
                <tr class="hover:bg-teal-50 transition-colors">
                    <td class="td capitalize">${item.label}</td>
                    <td class="td text-right font-mono font-bold ${high ? 'text-red-500' : 'text-teal-600'}">${item.value.toFixed(2)}%</td>
                    <td class="td text-center">
                        <span class="${item.isEstimated ? 'tag-nom' : 'tag-ofic'} text-xs px-2 py-0.5 rounded-full font-semibold">
                            ${item.isEstimated ? 'Est.' : 'Oficial'}
                        </span>
                    </td>
                </tr>`;
                });

                // ── Chart & Profit ──
                App.renderChart();
                App.updateProfit(adjPct);
            },

            renderChart() {
                const infData = State.data.inflationData;
                const range = document.getElementById('chart-range').value;
                const showInt = document.getElementById('chart-interanual').checked;

                let sliceData = range === 'all' ? infData : infData.slice(-parseInt(range));
                const labels = sliceData.map(d => d.label);
                const vals = sliceData.map(d => d.value);

                // Solo usar values no-null para el acumulado compuesto
                const valsClean = vals.filter(v => v !== null && v !== undefined);
                const accFactor = valsClean.reduce((acc, v) => acc * (1 + v / 100), 1) - 1;
                const accEl = document.getElementById('chart-accumulated');
                const labEl = document.getElementById('chart-range-label');
                if (accEl) accEl.textContent = (accFactor * 100).toFixed(2) + '%';
                if (labEl) {
                    const rangeLabel = range === 'all' ? 'todo el período' : `últimos ${range} meses`;
                    labEl.textContent = `(${rangeLabel} · compuesto)`;
                }

                // ── Peaks ──
                const maxVal = Math.max(...vals);
                const minVal = Math.min(...vals);

                const canvas = document.getElementById('inflation-chart');
                const ctxC = canvas.getContext('2d');

                const grad = ctxC.createLinearGradient(0, 0, 0, 150);
                grad.addColorStop(0, 'rgba(0,150,136,0.22)');
                grad.addColorStop(1, 'rgba(0,150,136,0)');

                const datasets = [{
                    label: 'Inflación mensual %',
                    data: vals,
                    borderColor: '#009688',
                    backgroundColor: grad,
                    borderWidth: 2.5,
                    pointBackgroundColor: vals.map(v => v === maxVal ? '#00796B' : v === minVal ? '#4DB6AC' : '#009688'),
                    pointRadius: vals.map(v => v === maxVal || v === minVal ? 6 : 3),
                    pointHoverRadius: 7,
                    tension: 0.35,
                    fill: true
                }];

                // Interanual overlay
                if (showInt && infData.length >= 13) {
                    const aligned = sliceData.map(d => {
                        const prevYear = infData.find(x =>
                            x.dateObj.getFullYear() === d.dateObj.getFullYear() - 1 &&
                            x.dateObj.getMonth() === d.dateObj.getMonth()
                        );
                        return prevYear ? prevYear.value : null;
                    });
                    datasets.push({
                        label: 'Mismo período año anterior',
                        data: aligned,
                        borderColor: '#80CBC4',
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        borderDash: [5, 4],
                        pointRadius: 2,
                        tension: 0.35,
                        fill: false
                    });
                }

                if (chartInst) chartInst.destroy();

                chartInst = new Chart(ctxC, {
                    type: 'line',
                    data: { labels, datasets },
                    plugins: [{
                        id: 'peakLabel',
                        afterDatasetsDraw(chart) {
                            const { ctx, data: cData, scales: { x, y } } = chart;
                            cData.datasets[0].data.forEach((v, i) => {
                                if (v === maxVal || v === minVal) {
                                    const xPos = x.getPixelForValue(i);
                                    const yPos = y.getPixelForValue(v);
                                    ctx.fillStyle = v === maxVal ? '#00695C' : '#26A69A';
                                    ctx.font = 'bold 10px Outfit, sans-serif';
                                    ctx.textAlign = 'center';
                                    // Peak above, valley below
                                    ctx.fillText(`${v}%`, xPos, v === maxVal ? yPos - 8 : yPos + 16);
                                }
                            });
                        }
                    }],
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,   // <-- respeta el contenedor de 150px
                        interaction: { intersect: false, mode: 'index' },
                        plugins: {
                            legend: {
                                display: showInt,
                                labels: { color: '#26A69A', font: { size: 10, family: 'Outfit' }, usePointStyle: true }
                            },
                            tooltip: {
                                backgroundColor: '#fff',
                                titleColor: '#004D40',
                                bodyColor: '#009688',
                                borderColor: '#B2DFDB',
                                borderWidth: 1,
                                titleFont: { family: 'Outfit', weight: '600' },
                                bodyFont: { family: 'Outfit' },
                                callbacks: { label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.y?.toFixed(2)}%` }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { color: '#80CBC4', font: { size: 9, family: 'Outfit' }, maxRotation: 45 }
                            },
                            y: {
                                grid: { color: '#E0F2F1' },
                                ticks: { color: '#80CBC4', font: { size: 9, family: 'Outfit' }, callback: v => v + '%' }
                            }
                        }
                    }
                });
            },

            updateProfit(currentRate) {
                const infData = State.data.inflationData;
                const trim = calcTrimester(infData);
                const rate = (typeof currentRate === 'number') ? currentRate : (trim ? trim.pct : 0);
                const cost = State.data.settings.userCostIncrease;

                document.getElementById('profit-alert').classList.add('hidden');
                document.getElementById('profit-warn').classList.add('hidden');
                document.getElementById('profit-ok').classList.add('hidden');

                if (cost > 0) {
                    const margin = rate - cost;
                    if (margin < 0) document.getElementById('profit-alert').classList.remove('hidden');
                    else if (margin < 3) document.getElementById('profit-warn').classList.remove('hidden');
                    else document.getElementById('profit-ok').classList.remove('hidden');
                }
            },

            handlers: {
                resetData() {
                    if (confirm('¿Borrar todas las sucursales y configuraciones?')) {
                        localStorage.removeItem('indexadorV3');
                        location.reload();
                    }
                },

                exportPDF() {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const infData = State.data.inflationData;
                    const trimResult = calcTrimester(infData);
                    const adjPct = trimResult ? trimResult.pct : 0;
                    const { startMonth, endMonth } = State.data.settings;

                    // Header
                    doc.setFillColor(0, 105, 92);
                    doc.rect(0, 0, 210, 40, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(20); doc.setFont('helvetica', 'bold');
                    doc.text('Informe de Indexación de Precios', 14, 18);
                    doc.setFontSize(9); doc.setFont('helvetica', 'normal');
                    doc.text(`Generado: ${new Date().toLocaleDateString('es-AR')} ${new Date().toLocaleTimeString('es-AR')}`, 14, 26);
                    doc.text(`Fuente: INDEC / API datos.gob.ar`, 14, 34);

                    // Summary
                    let y = 50;
                    doc.setTextColor(0, 77, 64);
                    doc.setFontSize(11); doc.setFont('helvetica', 'bold');
                    doc.text('Resumen del Ajuste', 14, y); y += 8;
                    doc.setFont('helvetica', 'normal'); doc.setFontSize(10);

                    // Etiquetas legibles para el período
                    const startLabel = infData.find(d => d.iso === startMonth)?.label || startMonth;
                    const endLabel = infData.find(d => d.iso === endMonth)?.label || endMonth;
                    doc.text(`Periodo seleccionado: ${startLabel} - ${endLabel}`, 14, y); y += 6;
                    doc.text(`Factor trimestral Dic-Ene-Feb: ${adjPct.toFixed(2)}%`, 14, y); y += 6;
                    doc.setTextColor(0, 77, 64);

                    // Table
                    const headers = [['Sucursal', 'Precio Base', 'Ajuste %', 'Nuevo Precio', 'Incremento']];
                    const rows = State.data.branches.map(b => {
                        const newAmt = b.amount * (1 + adjPct / 100);
                        return [b.name, UTILS.fmtCurrency(b.amount), `${adjPct.toFixed(2)}%`, UTILS.fmtCurrency(newAmt), UTILS.fmtCurrency(newAmt - b.amount)];
                    });
                    const totalBase = State.data.branches.reduce((a, b) => a + b.amount, 0);
                    const totalNew = totalBase * (1 + adjPct / 100);
                    rows.push(['TOTAL', UTILS.fmtCurrency(totalBase), '—', UTILS.fmtCurrency(totalNew), UTILS.fmtCurrency(totalNew - totalBase)]);

                    doc.autoTable({
                        startY: y + 4,
                        head: headers, body: rows,
                        theme: 'grid',
                        headStyles: { fillColor: [0, 105, 92], textColor: 255, fontStyle: 'bold', fontSize: 9 },
                        bodyStyles: { fontSize: 9, textColor: [0, 77, 64] },
                        didParseCell(d) {
                            if (d.section === 'body' && d.row.index === rows.length - 1) {
                                d.cell.styles.fontStyle = 'bold';
                                d.cell.styles.fillColor = [224, 242, 241];
                            }
                        }
                    });

                    // Pie de la cotizacion: texto limpio del legalNote
                    const fY = doc.lastAutoTable.finalY + 10;
                    if (trimResult) {
                        doc.setFontSize(8);
                        doc.setTextColor(80, 80, 80);
                        // Limpiar caracteres no ASCII antes de pasar a jsPDF
                        const footerText = trimResult.legalNote
                            .replace(/\n/g, ' ')
                            .replace(/[\u2013\u2014]/g, '-')
                            .replace(/[\u2018\u2019]/g, "'")
                            .replace(/[\u201C\u201D]/g, '"');
                        doc.text(footerText, 14, fY, { maxWidth: 182 });
                    }

                    doc.save('indexacion_ipc.pdf');
                }
            },

            ui: {
                toggleHistory() {
                    document.getElementById('history-container')?.classList.toggle('hidden');
                }
            }
        };

        window.app = App;
        window.Logic = Logic;
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>

</html>